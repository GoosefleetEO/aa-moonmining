{% extends 'moonplanner/base.html' %}
{% load i18n %}
{% load static %}

{% block details %}
    <span class="pull-right">
        {% if perms.moonplanner.upload_moon_scan %}
            <a class="btn btn-success btn-tabs"
                href="{% url 'moonplanner:upload_survey' %}">
                {% trans "Upload Moon Surveys" %}
            </a>
        {% endif %}
    </span>

    <!-- Nav tabs -->
    <ul id="myTabs" class="nav nav-tabs" role="tablist">
        {% if perms.moonplanner.extractions_access %}
            <li role="presentation">
                <a href="#tab_{{ MoonsCategory.OURS }}" aria-controls="tab_{{ MoonsCategory.OURS }}" role="tab" data-toggle="tab">{% trans "Owned Moons" %}</a>
            </li>
        {% endif %}
        {% if perms.moonplanner.view_all_moons %}
            <li role="presentation">
                <a href="#tab_{{ MoonsCategory.ALL }}" aria-controls="tab_{{ MoonsCategory.ALL }}" role="tab" data-toggle="tab">{% trans "All Moons" %}</a>
            </li>
        {% endif %}
        {% if perms.moonplanner.upload_moon_scan %}
            <li role="presentation">
                <a href="#tab_{{ MoonsCategory.UPLOADS }}" aria-controls="tab_{{ MoonsCategory.UPLOADS }}" role="tab" data-toggle="tab">{% trans "My Uploaded Moons" %}</a>
            </li>
         {% endif %}
    </ul>

    <div class="panel panel-default panel-tabs">
        <div class="panel-body">
            <div class="tab-content">
                {% include "moonplanner/partials/moons_tab.html" with category=MoonsCategory.OURS %}
                {% include "moonplanner/partials/moons_tab.html" with category=MoonsCategory.ALL %}
                {% include "moonplanner/partials/moons_tab.html" with category=MoonsCategory.UPLOADS %}
            </div>
            {% include 'moonplanner/partials/value_estimate_legend.html' %}
        </div>
    </div>

    {% if perms.moonplanner.extractions_access or perms.moonplanner.view_all_moons %}
        <script>var defaultTab = "tab_{{MoonsCategory.OURS}}";</script>
    {% elif perms.moonplanner.upload_moon_scan %}
        <script>var defaultTab = "tab_{{MoonsCategory.UPLOADS}}";</script>
    {% endif %}
{% endblock %}

{% block extra_javascript %}
    {% include 'bundles/datatables-js.html' %}
    <script type="text/javascript" src="{% static 'js/filterDropDown/filterDropDown.min.js' %}"></script>
    <script type="text/javascript" src="{% static 'moonplanner/js/global.js' %}"></script>
    <script type="text/javascript">
        $(function(){
            var def = {
                ajax: {
                    url: '',
                    dataSrc: '',
                    cache: true
                },
                columns: [
                    { data: 'moon_name' },
                    { data: 'corporation',
                        render: {
                            _: 'display',
                            sort: 'sort'
                        }
                    },
                    { data: 'solar_system_link' },
                    { data: 'region_name' },
                    { data: 'rarity_class',
                        render: {
                            _: 'display',
                            sort: 'sort'
                        }
                    },
                    {
                        data: 'value',
                        render: $.fn.dataTable.render.formatisk()
                    },
                    { data: 'details' },

                    { data: 'solar_system_name' },
                    { data: 'has_refinery_str' },
                    { data: 'corporation_name' },
                    { data: 'alliance_name' },
                    { data: 'rarity_class_label' },
                ],
                lengthMenu: DEFAULT_LENGTH_MENU,
                pageLength: DEFAULT_PAGE_LENGTH,
                order: [ [0, "asc"] ],
                columnDefs: [
                    { "orderable": false, "targets": [ 6 ] },
                    { "visible": false, "targets": [ 7, 8, 9, 10, 11 ] },
                ],
                filterDropDown: {
                    columns: [
                        {
                            idx: 10,
                            title: "Alliance"
                        },
                        {
                            idx: 9,
                            title: "Corporation"
                        },
                        {
                            idx: 3
                        },
                        {
                            idx: 7,
                            title: "System"
                        },
                        {
                            idx: 11,
                            title: "Rarity"
                        },
                        {
                            idx: 8,
                            title: "Our moon"
                        }
                    ],
                    bootstrap: true,
                    autoSize: false
                },
                createdRow: function( row, data, dataIndex )
                {
                    if (data['has_refinery'])
                    {
                        $(row).addClass('info');
                    }
                }
            };

            /* our moons table */
            def.ajax.url = '{% url "moonplanner:moons_data" MoonsCategory.OURS %}'
            var table = $('#table_{{ MoonsCategory.OURS }}').DataTable(def);
            table.on( 'xhr', function () {
                table.columns.adjust().draw();
                $("#loader_{{ MoonsCategory.OURS }}").hide();
                $("#wrapper_{{ MoonsCategory.OURS }}").show();
            } );

            /* all moons table */
            def.ajax.url = '{% url "moonplanner:moons_data" MoonsCategory.ALL %}'
            var table = $('#table_{{ MoonsCategory.ALL }}').DataTable(def);
            table.on( 'xhr', function () {
                table.columns.adjust().draw();
                $("#loader_{{ MoonsCategory.ALL }}").hide();
                $("#wrapper_{{ MoonsCategory.ALL }}").show();
            } );

            /* uploaded moons table */
            def.ajax.url = '{% url "moonplanner:moons_data" MoonsCategory.UPLOADS %}'
            var table = $('#table_{{ MoonsCategory.UPLOADS }}').DataTable(def);
            table.on( 'xhr', function () {
                table.columns.adjust().draw();
                $("#loader_{{ MoonsCategory.UPLOADS }}").hide();
                $("#wrapper_{{ MoonsCategory.UPLOADS }}").show();
            } );

            $('#myTabs a[href="#' + defaultTab + '"]').tab('show')

        });
    </script>
{% endblock %}

{% block extra_css %}
    {% include 'bundles/datatables-css.html' %}
    <link href="{% static 'moonplanner/css/global.css' %}" type="text/css" rel="stylesheet">
    <link href="{% static 'moonplanner/css/moons.css' %}" type="text/css" rel="stylesheet">
{% endblock %}

{% block extra_script %}
{% endblock %}
